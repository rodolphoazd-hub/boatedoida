<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Boate Simulator - Premium Edition</title>
  <style>
    :root {
      --primary-neon: #00f2ff;
      --secondary-neon: #ff00ea;
      --accent-neon: #bc00ff;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #050505;
      color: white;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    #club {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url('assets/nightclub_premium.png');
      background-size: cover;
      background-position: center;
      display: none;
      overflow: hidden;
    }

    /* Ambient Lighting Overlay */
    #club::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.5));
      pointer-events: none;
    }

    /* SVG Filter to remove green and add pixel-art contrast */
    .pixel-art {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      filter: url(#remove-green) contrast(1.2) brightness(1.1);
    }

    .character {
      position: absolute;
      width: 150px;
      height: 150px;
      background-image: url('assets/characters_green.png');
      background-size: 600px 600px;
      cursor: pointer;
      z-index: 10;
      transition: left 4s linear, top 4s linear;
      transform-origin: bottom center;
      will-change: left, top, transform;
    }

    /* Pixel Walking Animation */
    @keyframes pixel-walk {
      0% {
        transform: translateY(0) rotate(0deg);
      }

      25% {
        transform: translateY(-10px) rotate(5deg);
      }

      50% {
        transform: translateY(0) rotate(0deg);
      }

      75% {
        transform: translateY(-10px) rotate(-5deg);
      }

      100% {
        transform: translateY(0) rotate(0deg);
      }
    }

    .walking {
      animation: pixel-walk 0.6s infinite steps(4);
    }

    @keyframes bounce {

      0%,
      100% {
        transform: scaleY(1);
      }

      50% {
        transform: scaleY(0.9) translateY(2px);
      }
    }

    .dancing {
      animation: bounce 0.4s infinite steps(2);
    }

    /* Pixel Grid Overlay */
    #club::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 1;
      opacity: 0.5;
    }

    #dj-booth {
      position: absolute;
      left: 45%;
      top: 15%;
      width: 180px;
      height: 120px;
      background: rgba(0, 242, 255, 0.1);
      border: 2px solid var(--primary-neon);
      border-radius: 10px;
      cursor: pointer;
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--primary-neon);
      text-shadow: 0 0 10px var(--primary-neon);
    }

    #info-panel,
    #mission-panel {
      position: absolute;
      top: 20px;
      background: rgba(10, 10, 10, 0.9);
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    #info-panel {
      left: 20px;
      border: 1px solid var(--primary-neon);
    }

    #mission-panel {
      right: 20px;
      border: 1px solid var(--secondary-neon);
    }

    #status-msg {
      position: absolute;
      bottom: 25%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 32px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--primary-neon);
      text-shadow: 0 0 20px var(--primary-neon);
      pointer-events: none;
      opacity: 0;
      z-index: 200;
    }

    #inicio,
    #fim {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, #200044 0%, #050505 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .btn {
      padding: 18px 50px;
      font-size: 22px;
      background: linear-gradient(45deg, var(--accent-neon), var(--secondary-neon));
      border: none;
      border-radius: 50px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 40px;
      box-shadow: 0 0 30px rgba(188, 0, 255, 0.4);
      transition: all 0.3s;
    }

    .btn:hover {
      transform: scale(1.05) translateY(-3px);
      box-shadow: 0 10px 40px rgba(188, 0, 255, 0.7);
    }

    .mega-tip {
      position: absolute;
      color: #ffd700;
      font-weight: 900;
      font-size: 24px;
      pointer-events: none;
      animation: floatUp 1.2s forwards;
      z-index: 300;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    }

    @keyframes floatUp {
      0% {
        opacity: 0;
        transform: translateY(0) scale(0.5);
      }

      20% {
        opacity: 1;
        transform: translateY(-20px) scale(1.2);
      }

      100% {
        opacity: 0;
        transform: translateY(-80px) scale(1);
      }
    }
  </style>
</head>

<body>

  <!-- SVG Filter to remove green -->
  <svg style="position: absolute; width: 0; height: 0;">
    <filter id="remove-green">
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        1 -1 1 1 0" />
    </filter>
  </svg>

  <div id="inicio">
    <h1 style="font-size: 64px; margin-bottom: 0;">BOATE <span style="color: var(--primary-neon)">DOIDA</span></h1>
    <p style="color: #888; letter-spacing: 5px; text-transform: uppercase;">Premium Experience</p>
    <button class="btn" onclick="iniciarJogo()">START THE PARTY</button>
  </div>

  <div id="club">
    <div id="info-panel">
      <div style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold;">Promoter</div>
      <div id="jogador" style="font-size: 22px; font-weight: 900; color: var(--primary-neon)">---</div>
      <div style="margin-top: 12px; font-weight: bold;">FAMA: <span id="fama" style="color: #00ff00">0</span></div>
    </div>

    <div id="mission-panel">
      <div style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold;">Current Goal</div>
      <div id="missao" style="font-size: 18px; color: var(--secondary-neon); font-weight: bold;">Initializing...</div>
    </div>

    <div id="status-msg">BOA!</div>

    <div id="dj-booth" onclick="interagirDJ()">DJ BOOTH</div>

    <div id="world">
      <!-- Characters will be injected here -->
    </div>
  </div>

  <div id="fim" style="display: none;">
    <h1 style="font-size: 48px;">PARTY <span style="color: var(--accent-neon)">OVER</span></h1>
    <p style="font-size: 20px;">Legendary Fame: <span id="famaFinal"
        style="font-size: 40px; color: #00ff00; font-weight: 900;">0</span></p>
    <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
  </div>

  <audio id="player" loop></audio>

  <script>
    const API_URL = 'http://localhost:3000';
    let nomeJogador = "";
    let fama = 0;
    let missaoAtual = 0;
    let musicasTrocadas = 0;
    const characters = [];

    const missoes = [
      "Anime a pista! (Interaja com 3 pessoas)",
      "Troque 3 batidas no DJ booth!",
      "Aqueça o club! Consiga 50 de Fama",
      "Noite lendária! Consiga 100 de Fama",
      "Parabéns! Você é o Rei da Noite!"
    ];

    const HOTSPOTS = [
      { x: 50, y: 75, name: 'DANCE_FLOOR' },
      { x: 30, y: 70, name: 'DANCE_FLOOR' },
      { x: 70, y: 70, name: 'DANCE_FLOOR' },
      { x: 25, y: 55, name: 'BAR' },
      { x: 75, y: 55, name: 'VIP' },
      { x: 50, y: 35, name: 'DJ_FRONT' }
    ];

    async function iniciarJogo() {
      nomeJogador = prompt("Qual o seu Nick de DJ?", "DJ Doido");
      if (!nomeJogador) nomeJogador = "Anonimo";

      document.getElementById('jogador').innerText = nomeJogador;
      document.getElementById('inicio').style.display = 'none';
      document.getElementById('club').style.display = 'block';

      await carregarProgresso();
      spawnCharacters();
      atualizarInterface();
      tocarMusica();

      requestAnimationFrame(gameLoop);
    }

    async function carregarProgresso() {
      try {
        const res = await fetch(`${API_URL}/progresso/${nomeJogador}`);
        const data = await res.json();
        fama = data.fama || 0;
        missaoAtual = data.missao || 0;
      } catch (e) {
        console.warn("Offline mode active");
      }
    }

    async function salvarProgresso() {
      try {
        await fetch(`${API_URL}/progresso/${nomeJogador}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fama, missao: missaoAtual })
        });
      } catch (e) { }
    }

    class GameCharacter {
      constructor(index, startPos) {
        this.element = document.createElement('div');
        this.element.className = 'character pixel-art dancing';
        this.x = startPos.x;
        this.y = startPos.y;
        this.interacted = false;

        // Sheet mapping (assume 4x2 layout)
        const row = Math.floor(index / 4);
        const col = index % 4;
        this.element.style.backgroundPosition = `-${col * 150}px -${row * 300}px`;
        this.element.onclick = () => this.interact();

        document.getElementById('world').appendChild(this.element);
        this.updatePos();
        this.scheduleNextAction();
      }

      updatePos() {
        this.element.style.left = `calc(${this.x}% - 75px)`;
        this.element.style.top = `calc(${this.y}% - 120px)`;
        this.element.style.zIndex = Math.floor(this.y * 10);
      }

      scheduleNextAction() {
        const delay = 3000 + Math.random() * 5000;
        setTimeout(() => {
          this.decideNextState();
          this.scheduleNextAction();
        }, delay);
      }

      decideNextState() {
        const rand = Math.random();

        if (rand < 0.45) {
          // WALK MOVE
          const spot = HOTSPOTS[Math.floor(Math.random() * HOTSPOTS.length)];
          const targetX = spot.x + (Math.random() * 8 - 4);
          const targetY = spot.y + (Math.random() * 8 - 4);

          const dx = targetX - this.x;
          // Apply walking style and direction
          this.element.classList.remove('dancing');
          this.element.classList.add('walking');
          this.element.style.transform = dx > 0 ? 'scaleX(1)' : 'scaleX(-1)';

          this.x = targetX;
          this.y = targetY;
          this.updatePos();

          // Switch back to dancing when arrival (approx 4s)
          setTimeout(() => {
            this.element.classList.remove('walking');
            this.element.classList.add('dancing');
          }, 4000);

        } else if (rand < 0.85) {
          this.element.classList.remove('walking');
          this.element.classList.add('dancing');
        } else {
          this.element.classList.remove('walking', 'dancing');
        }
      }

      // Manual move loop no longer needed thanks to CSS transitions
      move() { }

      interact() {
        showTip(this.element);
        addFama(5);
        showStatus("ISSO AÍ!");

        if (missaoAtual === 0) {
          this.interacted = true;
          const interactedCount = characters.filter(c => c.interacted).length;
          if (interactedCount >= 3) completarMissao();
        }

        if (fama >= 50 && missaoAtual === 2) completarMissao();
        if (fama >= 100 && missaoAtual === 3) completarMissao();
      }
    }

    function spawnCharacters() {
      for (let i = 0; i < 8; i++) {
        const spot = HOTSPOTS[i % HOTSPOTS.length];
        characters.push(new GameCharacter(i, {
          x: spot.x + (Math.random() * 10 - 5),
          y: spot.y + (Math.random() * 10 - 5)
        }));
      }
    }

    function gameLoop() {
      characters.forEach(c => c.move());
      requestAnimationFrame(gameLoop);
    }

    function interagirDJ() {
      musicasTrocadas++;
      addFama(10);
      showStatus("DROP THE BASS!");
      tocarMusica();

      if (missaoAtual === 1 && musicasTrocadas >= 3) {
        completarMissao();
      }
    }

    function addFama(val) {
      fama += val;
      atualizarInterface();
      salvarProgresso();
    }

    function completarMissao() {
      missaoAtual++;
      addFama(20);
      showStatus("MISSÃO CUMPRIDA!", true);
      atualizarInterface();

      if (missaoAtual >= missoes.length - 1) {
        setTimeout(finalizarJogo, 3000);
      }
    }

    function atualizarInterface() {
      document.getElementById('fama').innerText = fama;
      document.getElementById('missao').innerText = missoes[missaoAtual];
    }

    function showStatus(text, long = false) {
      const msg = document.getElementById('status-msg');
      msg.innerText = text;
      msg.style.opacity = 1;
      msg.style.transform = 'translateX(-50%) scale(1.2)';
      setTimeout(() => {
        msg.style.opacity = 0;
        msg.style.transform = 'translateX(-50%) scale(1)';
      }, long ? 2500 : 1000);
    }

    function showTip(elem) {
      const rect = elem.getBoundingClientRect();
      const tip = document.createElement('div');
      tip.className = 'mega-tip';
      tip.innerText = "GORJETA!!";
      tip.style.left = `${rect.left + rect.width / 2}px`;
      tip.style.top = `${rect.top}px`;
      document.body.appendChild(tip);
      setTimeout(() => tip.remove(), 1200);
    }

    function tocarMusica() {
      const player = document.getElementById('player');
      const musicas = ['assets/music1.mp3', 'assets/music2.mp3', 'assets/music3.mp3'];
      player.src = musicas[musicasTrocadas % musicas.length];
      player.play().catch(() => console.log("Music interaction required"));
    }

    function finalizarJogo() {
      document.getElementById('club').style.display = 'none';
      document.getElementById('fim').style.display = 'flex';
      document.getElementById('famaFinal').innerText = fama;
    }
  </script>

</body>

</html>