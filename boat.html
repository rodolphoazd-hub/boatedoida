<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Boate Simulator - Premium Edition</title>
  <style>
    :root {
      --primary-neon: #00f2ff;
      --secondary-neon: #ff00ea;
      --accent-neon: #bc00ff;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #050505;
      color: white;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    #club {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url('assets/nightclub_premium.png');
      background-size: cover;
      background-position: center;
      display: none;
      overflow: hidden;
    }

    /* Ambient Lighting Overlay */
    #club::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.5));
      pointer-events: none;
    }

    /* High-Fidelity Pixel NPC Style */
    .pixel-art {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      filter: url(#remove-green);
    }

    .character {
      position: absolute;
      width: 150px;
      height: 150px;
      background-image: url('assets/characters_green.png');
      background-size: 600px 600px;
      /* 4x4 or 4x2 grid */
      cursor: pointer;
      z-index: 10;
      transition: left 3s linear, top 3s linear;
      transform-origin: bottom center;
      will-change: left, top, transform;
    }

    /* Pixel Art Animations (Step-based for retro feel) */
    @keyframes pixel-walk {
      0% {
        transform: translateY(0) rotate(0deg);
      }

      25% {
        transform: translateY(-10px) rotate(5deg);
      }

      50% {
        transform: translateY(0) rotate(0deg);
      }

      75% {
        transform: translateY(-10px) rotate(-5deg);
      }

      100% {
        transform: translateY(0) rotate(0deg);
      }
    }

    .walking {
      animation: pixel-walk 0.6s infinite steps(4);
    }

    @keyframes pixel-bounce {

      0%,
      100% {
        transform: scaleY(1);
      }

      50% {
        transform: scaleY(0.9) translateY(2px);
      }
    }

    .dancing {
      animation: pixel-bounce 0.4s infinite steps(2);
    }

    /* Pixel Grid Overlay */
    #club::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 1;
      opacity: 0.5;
    }

    #dj-booth {
      position: absolute;
      left: 45%;
      top: 15%;
      width: 180px;
      height: 120px;
      background: rgba(0, 242, 255, 0.1);
      border: 2px solid var(--primary-neon);
      border-radius: 10px;
      cursor: pointer;
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--primary-neon);
      text-shadow: 0 0 10px var(--primary-neon);
    }

    #info-panel,
    #mission-panel {
      position: absolute;
      top: 20px;
      background: rgba(10, 10, 10, 0.9);
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    /* Nightclub City Glass UI Components */
    .glass-panel {
      background: rgba(0, 150, 255, 0.15);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(0, 242, 255, 0.3);
      border-radius: 0;
      box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.1);
    }

    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      box-sizing: border-box;
      z-index: 1000;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
    }

    #bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding-bottom: 10px;
      z-index: 1000;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    }

    .ui-button {
      width: 60px;
      height: 60px;
      background: rgba(0, 100, 255, 0.2);
      border: 1px solid var(--primary-neon);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
    }

    .ui-button:hover {
      background: rgba(0, 242, 255, 0.4);
      transform: translateY(-5px);
    }

    /* Role Badges */
    .role-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 8px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      white-space: nowrap;
      color: var(--primary-neon);
      border: 1px solid var(--primary-neon);
      pointer-events: none;
    }

    #inicio,
    #fim {
      position: fixed;
      inset: 0;
      z-index: 5000;
      background: radial-gradient(circle at center, #1a1a2e, #0f0f1a);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .btn {
      padding: 18px 50px;
      font-size: 22px;
      background: linear-gradient(45deg, var(--accent-neon), var(--secondary-neon));
      border: none;
      border-radius: 50px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 40px;
      box-shadow: 0 0 30px rgba(188, 0, 255, 0.4);
      transition: all 0.3s;
    }

    .btn:hover {
      transform: scale(1.05) translateY(-3px);
      box-shadow: 0 10px 40px rgba(188, 0, 255, 0.7);
    }

    /* Dialogue Box */
    #dialogue-box {
      display: none;
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 700px;
      padding: 25px;
      z-index: 2000;
      cursor: pointer;
      border-left: 5px solid var(--primary-neon);
    }

    #dialogue-name {
      color: var(--primary-neon);
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    #dialogue-text {
      color: #fff;
      font-size: 20px;
      line-height: 1.5;
      font-family: 'Courier New', Courier, monospace;
    }

    .mega-tip {
      position: absolute;
      color: #ffd700;
      font-weight: 900;
      font-size: 24px;
      pointer-events: none;
      animation: floatUp 1.2s forwards;
      z-index: 300;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    }

    @keyframes floatUp {
      0% {
        opacity: 0;
        transform: translateY(0) scale(0.5);
      }

      20% {
        opacity: 1;
        transform: translateY(-20px) scale(1.2);
      }

      100% {
        opacity: 0;
        transform: translateY(-80px) scale(1);
      }
    }
  </style>
</head>

<body>

  <!-- SVG Filter to remove green -->
  <svg style="position: absolute; width: 0; height: 0;">
    <filter id="remove-green">
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        1 -1 1 1 0" />
    </filter>
  </svg>

  <div id="inicio">
    <h1 style="font-size: 64px; margin-bottom: 0;">BOATE <span style="color: var(--primary-neon)">DOIDA</span></h1>
    <p style="color: #888; letter-spacing: 5px; text-transform: uppercase;">Premium Experience</p>
    <button class="btn" onclick="iniciarJogo()">START THE PARTY</button>
  </div>

  <div id="club">
    <div id="top-bar">
      <div id="info-panel" class="glass-panel" style="position: static; padding: 5px 15px;">
        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Promoter</div>
        <div id="jogador" style="font-size: 16px; font-weight: 900; color: var(--primary-neon)">---</div>
      </div>

      <div id="mission-panel" class="glass-panel" style="position: static; padding: 5px 15px;">
        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Mission</div>
        <div id="missao" style="font-size: 14px; color: var(--secondary-neon); font-weight: bold;">Initialing...</div>
      </div>

      <div class="glass-panel" style="padding: 5px 15px;">
        <div style="font-size: 10px; color: #888;">FAME</div>
        <div id="fama" style="font-size: 18px; color: #00ff00; font-weight: 900;">0</div>
      </div>
    </div>

    <div id="status-msg">BOA!</div>

    <div id="dj-booth" style="opacity: 0.5;">DJ BOOTH</div>

    <div id="world">
      <!-- Characters will be injected here -->
    </div>

    <div id="bottom-bar">
      <div class="ui-button">üè†</div>
      <div class="ui-button">üéÅ</div>
      <div class="ui-button">üëó</div>
      <div class="ui-button">üéµ</div>
      <div class="ui-button">üõí</div>
    </div>
  </div>

  <div id="fim" style="display: none;">
    <h1 style="font-size: 48px;">PARTY <span style="color: var(--accent-neon)">OVER</span></h1>
    <p style="font-size: 20px;">Legendary Fame: <span id="famaFinal"
        style="font-size: 40px; color: #00ff00; font-weight: 900;">0</span></p>
    <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
  </div>

  <audio id="player" loop></audio>

  <script>
    const API_URL = 'http://localhost:3000';
    let nomeJogador = "";
    let fama = 0;
    let missaoAtual = 0;
    let musicasTrocadas = 0;
    const characters = [];

    const missoes = [
      "Anime a pista! (Interaja com 3 pessoas)",
      "Troque 3 batidas no DJ booth!",
      "Aque√ßa o club! Consiga 50 de Fama",
      "Noite lend√°ria! Consiga 100 de Fama",
      "Parab√©ns! Voc√™ √© o Rei da Noite!"
    ];

    const HOTSPOTS = [
      { x: 50, y: 75, name: 'DANCE_FLOOR' },
      { x: 30, y: 70, name: 'DANCE_FLOOR' },
      { x: 70, y: 70, name: 'DANCE_FLOOR' },
      { x: 25, y: 55, name: 'BAR' },
      { x: 75, y: 55, name: 'VIP' },
      { x: 50, y: 35, name: 'DJ_FRONT' }
    ];

    async function iniciarJogo() {
      nomeJogador = prompt("Qual o seu Nick de DJ?", "DJ Doido");
      if (!nomeJogador) nomeJogador = "Anonimo";

      document.getElementById('jogador').innerText = nomeJogador;
      document.getElementById('inicio').style.display = 'none';
      document.getElementById('club').style.display = 'block';

      await carregarProgresso();
      spawnCharacters();
      atualizarInterface();
      tocarMusica();

      requestAnimationFrame(gameLoop);
    }

    async function carregarProgresso() {
      try {
        const res = await fetch(`${API_URL}/progresso/${nomeJogador}`);
        const data = await res.json();
        fama = data.fama || 0;
        missaoAtual = data.missao || 0;
      } catch (e) {
        console.warn("Offline mode active");
      }
    }

    async function salvarProgresso() {
      try {
        await fetch(`${API_URL}/progresso/${nomeJogador}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fama, missao: missaoAtual })
        });
      } catch (e) { }
    }

    /* Audio Engine for Fluid Music */
    class AudioEngine {
      constructor() {
        this.players = [new Audio(), new Audio()];
        this.currentPlayerIndex = 0;
        this.fadeOutTime = 2000;
        this.fadeInTime = 2000;
      }

      play(src) {
        const nextPlayerIndex = 1 - this.currentPlayerIndex;
        const current = this.players[this.currentPlayerIndex];
        const next = this.players[nextPlayerIndex];

        next.src = src;
        next.volume = 0;
        next.play();

        this.crossfade(current, next);
        this.currentPlayerIndex = nextPlayerIndex;
      }

      crossfade(outPlayer, inPlayer) {
        let vol = 0;
        const interval = 50;
        const step = interval / this.fadeInTime;

        const fade = setInterval(() => {
          vol += step;
          if (vol >= 1) {
            inPlayer.volume = 1;
            outPlayer.volume = 0;
            outPlayer.pause();
            clearInterval(fade);
          } else {
            inPlayer.volume = vol;
            outPlayer.volume = 1 - vol;
          }
        }, interval);
      }
    }

    const audio = new AudioEngine();

    /* Dialogue System */
    function showDialogue(name, text, callback = null) {
      const box = document.getElementById('dialogue-box');
      document.getElementById('dialogue-name').innerText = name;
      document.getElementById('dialogue-text').innerText = text;
      box.style.display = 'block';
      box.onclick = () => {
        box.style.display = 'none';
        if (callback) callback();
      };
    }

    class GameCharacter {
      constructor(index, startPos, role = 'GUEST', name = '') {
        this.element = document.createElement('div');
        this.element.className = 'character pixel-art dancing';
        this.x = startPos.x;
        this.y = startPos.y;
        this.role = role;
        this.name = name || role;
        this.interacted = false;

        if (role !== 'GUEST') {
          const badge = document.createElement('div');
          badge.className = 'role-label';
          badge.innerText = role;
          this.element.appendChild(badge);
        }

        this.element.onclick = () => this.handleInteraction();

        // Sheet mapping for characters_green.png (4 columns)
        const row = Math.floor(index / 4);
        const col = index % 4;
        this.element.style.backgroundPosition = `-${col * 150}px -${row * 300}px`;

        document.getElementById('world').appendChild(this.element);
        this.updatePos();
        if (role === 'GUEST') this.scheduleNextAction();
      }

      updatePos() {
        this.element.style.left = `calc(${this.x}% - 75px)`;
        this.element.style.top = `calc(${this.y}% - 120px)`;
        this.element.style.zIndex = Math.floor(this.y * 10);
      }

      handleInteraction() {
        if (this.role === 'ALEX' && chapter === 0) {
          showDialogue("Alex (Gerente)", "Bem-vindo √† Boate Noite Selvagem! Sou o Alex. Para come√ßar sua fama, troque a m√∫sica no DJ e fale com 3 convidados.", () => {
            tutorialComplete = true;
          });
        } else if (this.role === 'DJ') {
          interagirDJ();
        } else {
          showTip(this.element);
          addFama(this.role === 'GUEST' ? 5 : 15);
          showStatus(this.role === 'GUEST' ? "OBA!!" : `SALVE ${this.name}!`);
          this.interacted = true;
          checkMissions();
        }
      }

      scheduleNextAction() {
        const delay = 3000 + Math.random() * 5000;
        setTimeout(() => {
          this.decideNextState();
          this.scheduleNextAction();
        }, delay);
      }

      decideNextState() {
        if (this.role !== 'GUEST') return;
        const rand = Math.random();
        if (rand < 0.45) {
          const spot = HOTSPOTS[Math.floor(Math.random() * HOTSPOTS.length)];
          const targetX = spot.x + (Math.random() * 8 - 4);
          const targetY = spot.y + (Math.random() * 8 - 4);
          const dx = targetX - this.x;
          this.element.classList.remove('dancing');
          this.element.classList.add('walking');
          this.element.style.transform = dx > 0 ? 'scaleX(1)' : 'scaleX(-1)';
          this.x = targetX;
          this.y = targetY;
          this.updatePos();
          setTimeout(() => {
            this.element.classList.remove('walking');
            this.element.classList.add('dancing');
          }, 3000);
        } else if (rand < 0.85) {
          this.element.classList.remove('walking');
          this.element.classList.add('dancing');
        } else {
          this.element.classList.remove('walking', 'dancing');
        }
      }

      move() { }
    }

    let chapter = 0;
    let tutorialComplete = false;
    const chapters = [
      "Tutorial: Conhe√ßa Alex",
      "Cap 1: Conquistando a Boate",
      "Cap 2: Segredos da Noite",
      "Cap 3: Festa e Conquista",
      "Cap 4: O Grande Confronto"
    ];

    function spawnCharacters() {
      // 1. Alex (Gerente)
      characters.push(new GameCharacter(4, { x: 15, y: 70 }, 'ALEX'));

      // 2. DJ
      characters.push(new GameCharacter(0, { x: 50, y: 30 }, 'DJ'));

      // 3. Rafael (Seguran√ßa)
      characters.push(new GameCharacter(1, { x: 80, y: 80 }, 'SECURITY', 'RAFAEL'));

      // 4. Barman
      characters.push(new GameCharacter(5, { x: 25, y: 50 }, 'BARMAN'));

      // 5.Guests
      for (let i = 0; i < 30; i++) {
        const spot = HOTSPOTS[i % HOTSPOTS.length];
        characters.push(new GameCharacter(i % 16, {
          x: spot.x + (Math.random() * 20 - 10),
          y: spot.y + (Math.random() * 20 - 10)
        }, 'GUEST'));
      }
    }

    function gameLoop() {
      characters.forEach(c => c.move());
      requestAnimationFrame(gameLoop);
    }

    function interagirDJ() {
      musicasTrocadas++;
      addFama(10);
      showStatus("NOVA TRACK!");
      tocarMusica();
      checkMissions();
    }

    function addFama(val) {
      fama += val;
      atualizarInterface();
      salvarProgresso();
    }

    function completarMissao() {
      missaoAtual++;
      addFama(20);
      showStatus("MISS√ÉO CUMPRIDA!", true);
      atualizarInterface();

      if (missaoAtual >= missoes.length - 1) {
        setTimeout(finalizarJogo, 3000);
      }
    }

    function checkMissions() {
      const interactedCount = characters.filter(c => c.interacted).length;
      if (chapter === 0 && tutorialComplete && musicasTrocadas > 0 && interactedCount >= 3) {
        completarMissao();
      }
    }

    function atualizarInterface() {
      document.getElementById('fama').innerText = fama;
      document.getElementById('missao').innerText = missoes[missaoAtual];
    }

    function showStatus(text, long = false) {
      const msg = document.getElementById('status-msg');
      msg.innerText = text;
      msg.style.opacity = 1;
      msg.style.transform = 'translateX(-50%) scale(1.2)';
      setTimeout(() => {
        msg.style.opacity = 0;
        msg.style.transform = 'translateX(-50%) scale(1)';
      }, long ? 2500 : 1000);
    }

    function showTip(elem) {
      const rect = elem.getBoundingClientRect();
      const tip = document.createElement('div');
      tip.className = 'mega-tip';
      tip.innerText = "GORJETA!!";
      tip.style.left = `${rect.left + rect.width / 2}px`;
      tip.style.top = `${rect.top}px`;
      document.body.appendChild(tip);
      setTimeout(() => tip.remove(), 1200);
    }

    function tocarMusica() {
      const player = document.getElementById('player');
      const musicas = ['assets/music1.mp3', 'assets/music2.mp3', 'assets/music3.mp3'];
      player.src = musicas[musicasTrocadas % musicas.length];
      player.play().catch(() => console.log("Music interaction required"));
    }

    function finalizarJogo() {
      document.getElementById('club').style.display = 'none';
      document.getElementById('fim').style.display = 'flex';
      document.getElementById('famaFinal').innerText = fama;
    }
  </script>

</body>

</html>