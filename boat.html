<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Boate Simulator - Premium Edition</title>
  <style>
    :root {
      --primary-neon: #00f2ff;
      --secondary-neon: #ff00ea;
      --accent-neon: #bc00ff;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #050505;
      color: white;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    #club {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url('assets/nightclub_premium.png');
      background-size: cover;
      background-position: center;
      display: none;
      overflow: hidden;
    }

    /* Ambient Lighting Overlay */
    #club::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.5));
      pointer-events: none;
    }

    /* High-Fidelity Pixel NPC Style */
    .pixel-art {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      filter: url(#remove-green);
    }

    .character {
      position: absolute;
      width: 150px;
      height: 150px;
      background-image: url('assets/characters_green.png');
      background-size: 600px 600px;
      /* 4x4 or 4x2 grid */
      cursor: pointer;
      z-index: 10;
      transition: left 3.5s cubic-bezier(0.4, 0, 0.2, 1), top 3.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.2s;
      transform-origin: bottom center;
      will-change: left, top, transform;
    }

    .character:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.5));
    }

    /* Boss Sheet specific */
    .boss-character {
      width: 250px !important;
      height: 380px !important;
      background-image: url('assets/boss_sheet.png') !important;
      background-size: 1000px 380px !important;
      /* Fixed size based on 4 frames of 250px */
      background-repeat: no-repeat !important;
    }

    /* Alex Frames mapping */
    .alex-character {
      width: 200px !important;
      height: 300px !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center bottom !important;
    }

    /* Shop UI Tabs and Categories */
    .shop-header {
      display: flex;
      gap: 15px;
      margin: 15px 0;
      border-bottom: 1px solid rgba(0, 150, 255, 0.3);
      padding-bottom: 10px;
    }

    .shop-tab {
      cursor: pointer;
      color: #888;
      font-size: 14px;
      transition: all 0.3s;
      text-transform: uppercase;
      font-weight: 900;
    }

    .shop-tab:hover,
    .shop-tab.active {
      color: var(--primary-neon);
      text-shadow: 0 0 10px var(--primary-neon);
    }

    /* Pixel Art Animations (Step-based for retro feel) */
    @keyframes pixel-walk {
      0% {
        transform: translateY(0) rotate(0deg);
      }

      25% {
        transform: translateY(-10px) rotate(5deg);
      }

      50% {
        transform: translateY(0) rotate(0deg);
      }

      75% {
        transform: translateY(-10px) rotate(-5deg);
      }

      100% {
        transform: translateY(0) rotate(0deg);
      }
    }

    .walking {
      animation: pixel-walk 0.6s infinite steps(4);
    }

    @keyframes pixel-bounce {

      0%,
      100% {
        transform: scaleY(1);
      }

      50% {
        transform: scaleY(0.9) translateY(2px);
      }
    }

    .dancing {
      animation: pixel-bounce 0.4s infinite steps(2);
    }

    /* Pixel Grid Overlay */
    #club::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 1;
      opacity: 0.5;
    }

    #dj-booth {
      position: absolute;
      left: 45%;
      top: 15%;
      width: 180px;
      height: 120px;
      background: rgba(0, 242, 255, 0.1);
      border: 2px solid var(--primary-neon);
      border-radius: 10px;
      cursor: pointer;
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--primary-neon);
      text-shadow: 0 0 10px var(--primary-neon);
    }

    #info-panel,
    #mission-panel {
      position: absolute;
      top: 20px;
      background: rgba(10, 10, 10, 0.9);
      padding: 15px 25px;
      border-radius: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    /* Nightclub City Glass UI Components */
    .glass-panel {
      background: rgba(0, 150, 255, 0.15);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(0, 242, 255, 0.3);
      border-radius: 0;
      box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.1);
    }

    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      box-sizing: border-box;
      z-index: 1000;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
    }

    #bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding-bottom: 10px;
      z-index: 1000;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    }

    .ui-button {
      width: 60px;
      height: 60px;
      background: rgba(0, 100, 255, 0.2);
      border: 1px solid var(--primary-neon);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
    }

    .ui-button:hover {
      background: rgba(0, 242, 255, 0.4);
      transform: translateY(-5px);
    }

    /* Role Badges */
    .role-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 8px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 900;
      text-transform: uppercase;
      white-space: nowrap;
      color: var(--primary-neon);
      border: 1px solid var(--primary-neon);
      pointer-events: none;
    }

    #inicio,
    #fim {
      position: fixed;
      inset: 0;
      z-index: 5000;
      background: radial-gradient(circle at center, #1a1a2e, #0f0f1a);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .btn {
      padding: 18px 50px;
      font-size: 22px;
      background: linear-gradient(45deg, var(--accent-neon), var(--secondary-neon));
      border: none;
      border-radius: 50px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 40px;
      box-shadow: 0 0 30px rgba(188, 0, 255, 0.4);
      transition: all 0.3s;
    }

    .btn:hover {
      transform: scale(1.05) translateY(-3px);
      box-shadow: 0 10px 40px rgba(188, 0, 255, 0.7);
    }

    /* Dialogue Box */
    #dialogue-box {
      display: none;
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 700px;
      padding: 25px;
      z-index: 2000;
      cursor: pointer;
      border-left: 5px solid var(--primary-neon);
    }

    #dialogue-name {
      color: var(--primary-neon);
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    #dialogue-text {
      color: #fff;
      font-size: 20px;
      line-height: 1.5;
      font-family: 'Courier New', Courier, monospace;
    }

    /* Shop UI */
    #shop-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 4000;
      padding: 40px;
      overflow-y: auto;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .shop-item {
      padding: 15px;
      border: 1px solid var(--primary-neon);
      background: rgba(0, 150, 255, 0.1);
      text-align: center;
      transition: all 0.3s;
    }

    .shop-item:hover {
      background: rgba(0, 150, 255, 0.3);
      transform: translateY(-5px);
    }

    .money-stat {
      color: #ffd700;
      font-weight: 900;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
  </style>
</head>

<body>

  <!-- SVG Filter to remove green -->
  <svg style="position: absolute; width: 0; height: 0;">
    <filter id="remove-green">
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        1 -1 1 1 0" />
    </filter>
  </svg>

  <div id="inicio">
    <h1 style="font-size: 64px; margin-bottom: 0;">BOATE <span style="color: var(--primary-neon)">DOIDA</span></h1>
    <p style="color: #888; letter-spacing: 5px; text-transform: uppercase;">Premium Experience</p>
    <button class="btn" onclick="iniciarJogo()">START THE PARTY</button>
  </div>

  <div id="dialogue-box" class="glass-panel">
    <div id="dialogue-name"></div>
    <div id="dialogue-text"></div>
    <div style="font-size: 10px; color: #888; margin-top: 10px; text-align: right;">[ CLIQUE PARA CONTINUAR ]</div>
  </div>

  <div id="club">
    <div id="top-bar">
      <div id="info-panel" class="glass-panel" style="position: static; padding: 5px 15px;">
        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Promoter</div>
        <div id="jogador" style="font-size: 16px; font-weight: 900; color: var(--primary-neon)">---</div>
      </div>

      <div id="mission-panel" class="glass-panel" style="position: static; padding: 5px 15px;">
        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Mission</div>
        <div id="missao" style="font-size: 14px; color: var(--secondary-neon); font-weight: bold;">Initialing...</div>
      </div>

      <div class="glass-panel" style="padding: 5px 15px;">
        <div style="font-size: 10px; color: #888;">FAME</div>
        <div id="fama" style="font-size: 18px; color: #00ff00; font-weight: 900;">0</div>
      </div>

      <div class="glass-panel" style="padding: 5px 15px;">
        <div style="font-size: 10px; color: #888;">CASH</div>
        <div id="dinheiro" class="money-stat" style="font-size: 18px;">$0</div>
      </div>

      <div class="glass-panel" style="padding: 5px 15px; flex-grow: 1; max-width: 200px; text-align: left;">
        <div style="font-size: 10px; color: #888;">NOW PLAYING</div>
        <div id="music-info"
          style="font-size: 12px; color: var(--primary-neon); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
          ...</div>
      </div>
    </div>

    <div id="status-msg">BOA!</div>

    <div id="dj-booth" style="opacity: 0.5;">DJ BOOTH</div>

    <div id="world">
      <!-- Characters will be injected here -->
    </div>

    <div id="bottom-bar">
      <div class="ui-button">üè†</div>
      <div class="ui-button">üéÅ</div>
      <div class="ui-button">üëó</div>
      <div class="ui-button" onclick="musicasTrocadas++; interagirDJ()">üéµ</div>
      <div class="ui-button" onclick="toggleShop()">üõí</div>
    </div>

    <!-- Shop Overlay -->
    <div id="shop-overlay">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: var(--primary-neon); margin: 0;">CYBER STORE</h2>
        <div id="shop-tabs" class="shop-header">
          <div class="shop-tab active" onclick="loadShopItems('all')">TUDO</div>
          <div class="shop-tab" onclick="loadShopItems('gift')">PRESENTES</div>
          <div class="shop-tab" onclick="loadShopItems('upgrade')">UPGRADES</div>
        </div>
        <button class="btn" style="margin: 0; padding: 10px 20px;" onclick="toggleShop()">FECHAR</button>
      </div>
      <div id="loja-lista" class="shop-grid"></div>
    </div>
  </div>

  <div id="fim" style="display: none;">
    <h1 style="font-size: 48px;">PARTY <span style="color: var(--accent-neon)">OVER</span></h1>
    <p style="font-size: 20px;">Legendary Fame: <span id="famaFinal"
        style="font-size: 40px; color: #00ff00; font-weight: 900;">0</span></p>
    <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
  </div>

  <audio id="player" loop></audio>

  <script>
    const API_URL = 'http://localhost:3000';
    let nomeJogador = "";
    let fama = 0;
    let chapter = 0;
    let dinheiro = 100;
    let musicasTrocadas = 0;
    let playlist = [];
    let characters = [];
    let inventario = [];
    let shopCategory = 'all';

    const missoes = [
      "Anime a pista! (Interaja com 3 pessoas)",
      "Troque 3 batidas no DJ booth!",
      "Aque√ßa o club! Consiga 50 de Fama",
      "Noite lend√°ria! Consiga 100 de Fama",
      "Parab√©ns! Voc√™ √© o Rei da Noite!"
    ];

    const HOTSPOTS = [
      { x: 50, y: 75, name: 'DANCE_FLOOR' },
      { x: 30, y: 70, name: 'DANCE_FLOOR' },
      { x: 70, y: 70, name: 'DANCE_FLOOR' },
      { x: 25, y: 55, name: 'BAR' },
      { x: 75, y: 55, name: 'VIP' },
      { x: 50, y: 35, name: 'DJ_FRONT' },
      { x: 10, y: 30, name: 'OFFICE' }
    ];

    async function iniciarJogo() {
      nomeJogador = prompt("Qual o seu Nick de DJ?", "DJ Doido");
      if (!nomeJogador) nomeJogador = "Anonimo";

      document.getElementById('jogador').innerText = nomeJogador;
      document.getElementById('inicio').style.display = 'none';
      document.getElementById('club').style.display = 'block';

      await carregarProgresso();
      spawnCharacters();
      atualizarInterface();
      tocarMusica();

      requestAnimationFrame(gameLoop);
    }

    async function carregarProgresso() {
      // Hardcoded fallbacks for resilience
      const fallbackPlaylist = [
        { url: 'assets/music1.mp3', title: "Cyber Night", artist: "SynthWave Pro" },
        { url: 'assets/music2.mp3', title: "Neon Pulse", artist: "Glitch Master" }
      ];

      try {
        const res = await fetch(`${API_URL}/progresso/${nomeJogador}`);
        if (res.ok) {
          const data = await res.json();
          fama = data.fama || 0;
          chapter = data.chapter || 0;
          dinheiro = data.dinheiro || 100;
        }
      } catch (e) { console.warn("Could not load progress from server"); }

      // Fetch from Jamendo API for real "online" music
      try {
        const jamendoRes = await fetch('https://api.jamendo.com/v3.0/tracks/?client_id=56d30c95&format=json&limit=10&tags=cyberpunk,electronic&order=popularity_week');
        const jamendoData = await jamendoRes.json();
        if (jamendoData.results && jamendoData.results.length > 0) {
          playlist = jamendoData.results.map(t => ({
            id: t.id,
            title: t.name,
            artist: t.artist_name,
            url: t.audio
          }));
        } else {
          throw new Error("No Jamendo results");
        }
      } catch (je) {
        console.warn("Jamendo API failed, using server/local fallback");
        try {
          const musicasRes = await fetch(`${API_URL}/musicas`);
          if (musicasRes.ok) {
            playlist = await musicasRes.json();
          } else { throw new Error(); }
        } catch (me) {
          playlist = fallbackPlaylist;
        }
      }

      if (!playlist || playlist.length === 0) playlist = fallbackPlaylist;
    }

    async function salvarProgresso() {
      try {
        await fetch(`${API_URL}/progresso/${nomeJogador}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fama, chapter, dinheiro })
        });
      } catch (e) { }
    }

    /* Audio Engine for Fluid Music */
    class AudioEngine {
      constructor() {
        this.players = [new Audio(), new Audio()];
        this.currentPlayerIndex = 0;
        this.fadeOutTime = 2000;
        this.fadeInTime = 2000;
      }

      play(src) {
        const nextPlayerIndex = 1 - this.currentPlayerIndex;
        const current = this.players[this.currentPlayerIndex];
        const next = this.players[nextPlayerIndex];

        next.src = src;
        next.volume = 0;
        next.play();

        this.crossfade(current, next);
        this.currentPlayerIndex = nextPlayerIndex;
      }

      crossfade(outPlayer, inPlayer) {
        let vol = 0;
        const interval = 50;
        const step = interval / this.fadeInTime;

        const fade = setInterval(() => {
          vol += step;
          if (vol >= 1) {
            inPlayer.volume = 1;
            outPlayer.volume = 0;
            outPlayer.pause();
            clearInterval(fade);
          } else {
            inPlayer.volume = vol;
            outPlayer.volume = 1 - vol;
          }
        }, interval);
      }
    }

    const audio = new AudioEngine();

    /* Dialogue System */
    function showDialogue(name, text, callback = null) {
      const box = document.getElementById('dialogue-box');
      document.getElementById('dialogue-name').innerText = name;
      document.getElementById('dialogue-text').innerText = text;

      // Add Gift button if it's a key NPC
      const giftBtn = document.createElement('button');
      giftBtn.className = 'btn';
      giftBtn.style.padding = '5px 15px';
      giftBtn.style.fontSize = '12px';
      giftBtn.style.marginTop = '10px';
      giftBtn.innerText = "üéÅ DAR PRESENTE";
      giftBtn.onclick = (e) => {
        e.stopPropagation();
        showGiftMenu(name.split(' ')[0].toUpperCase(), name);
      };

      const keyRoles = ['ALEX', 'LIA', 'VINCENT', 'SOFIA', 'RAFAEL'];
      const isKey = keyRoles.some(r => name.toUpperCase().includes(r));

      const existingBtn = box.querySelector('.gift-btn-container');
      if (existingBtn) existingBtn.remove();

      if (isKey) {
        const container = document.createElement('div');
        container.className = 'gift-btn-container';
        container.appendChild(giftBtn);
        document.getElementById('dialogue-text').appendChild(container);
      }

      box.style.display = 'block';
      box.onclick = () => {
        box.style.display = 'none';
        if (callback) callback();
      };
    }

    class GameCharacter {
      constructor(index, startPos, role = 'GUEST', name = '') {
        this.element = document.createElement('div');
        this.element.className = 'character pixel-art dancing';
        this.x = startPos.x;
        this.y = startPos.y;
        this.role = role;
        this.name = name || role;
        this.interacted = false;

        if (role !== 'GUEST') {
          const badge = document.createElement('div');
          badge.className = 'role-label';
          badge.innerText = role;
          this.element.appendChild(badge);
        }

        this.element.onclick = () => this.handleInteraction();

        // Special handling for unique characters
        if (role === 'BOSS') {
          this.element.classList.add('boss-character');
          this.setPose(0); // Default idle
        } else if (role === 'ALEX') {
          this.element.classList.add('alex-character');
          this.setAlexFrame(1);
        } else {
          // Sheet mapping for characters_green.png (4 columns)
          const row = Math.floor(index / 4);
          const col = index % 4;
          this.element.style.backgroundPosition = `-${col * 150}px -${row * 300}px`;

          // Randomize guest colors slightly for variety
          if (role === 'GUEST') {
            const hue = Math.floor(Math.random() * 30) - 15;
            this.element.style.filter = `hue-rotate(${hue}deg) brightness(${0.9 + Math.random() * 0.2})`;
          }
        }

        document.getElementById('world').appendChild(this.element);
        this.updatePos();
        if (role === 'GUEST') this.scheduleNextAction();
        if (role === 'BOSS') this.startBossBehavior();
        if (role === 'ALEX') this.startAlexBehavior();
      }

      setPose(index) {
        if (this.role !== 'BOSS') return;
        this.element.style.backgroundPosition = `-${index * 250}px 0px`;
      }

      setAlexFrame(frame) {
        if (this.role !== 'ALEX') return;
        this.element.style.backgroundImage = `url('assets/Alex${frame}.png')`;
      }

      startBossBehavior() {
        setInterval(() => {
          if (Math.random() > 0.7) {
            const poses = [0, 2, 3]; // Stand, Dance, Call (Point is for interaction)
            this.setPose(poses[Math.floor(Math.random() * poses.length)]);
          }
        }, 4000);
      }

      startAlexBehavior() {
        setInterval(() => {
          if (Math.random() > 0.6) {
            const frame = Math.floor(Math.random() * 4) + 1;
            this.setAlexFrame(frame);
          }
        }, 5000);
      }

      updatePos() {
        // Adjust offset if BOSS or ALEX
        let offsetX = 75, offsetY = 120;
        if (this.role === 'BOSS') { offsetX = 125; offsetY = 350; }
        if (this.role === 'ALEX') { offsetX = 100; offsetY = 280; }

        this.element.style.left = `calc(${this.x}% - ${offsetX}px)`;
        this.element.style.top = `calc(${this.y}% - ${offsetY}px)`;
        this.element.style.zIndex = Math.floor(this.y * 10);
      }

      handleInteraction() {
        if (this.role === 'ALEX') {
          this.setAlexFrame(3); // Point/Gesture on interaction
          if (chapter === 0) {
            showDialogue("Alex (Gerente)", "Bem-vindo √† Boate Noite Selvagem! Sou o Alex. Para come√ßar sua fama, troque a m√∫sica no DJ e fale com 3 convidados.", () => {
              tutorialComplete = true;
              this.setAlexFrame(1);
            });
          } else if (chapter === 1) {
            showDialogue("Alex", "Voc√™ est√° mandando bem! Fale com a Lia na pista, ela tem dicas valiosas.", () => this.setAlexFrame(1));
          } else if (chapter === 2) {
            showDialogue("Alex", "O clima est√° estranho hoje... O Rafael parecia preocupado com algo na entrada.", () => this.setAlexFrame(1));
          } else if (chapter >= 3) {
            showDialogue("Alex", "Foque na Sofia! Ela quer roubar seu lugar no DJ Booth.", () => this.setAlexFrame(1));
          }
        } else if (this.role === 'BOSS') {
          this.setPose(1); // POINT pose on interaction
          if (chapter === 4) {
            showDialogue("Vincent (O Dono)", "O Alex est√° acabado. Tenho uma proposta: esque√ßa aqueles documentos e voc√™ ser√° meu parceiro n√∫mero 1.", () => {
              showStatus("ESCOLHA SEU DESTINO", true);
              confirmarEscolhaFinal();
              this.setPose(0);
            });
          } else {
            showDialogue("Vincent (O Dono)", "Nada mal para um novato. Mas para ser o Rei da Noite, voc√™ precisar√° de mais do que apenas m√∫sica. Mostre-me que voc√™ sabe gastar na minha loja.", () => {
              this.setPose(0);
            });
          }
        } else if (this.role === 'LIA') {
          showDialogue("Lia (Dan√ßarina)", "Ei! Para bombar essa boate, mude o ritmo pro eletr√¥nico e garanta que 5 VIPs estejam felizes!");
        } else if (this.role === 'SOFIA') {
          if (chapter === 3) {
            showDialogue("Sofia (DJ Rival)", "Ent√£o voc√™ √© o queridinho do Alex? Vamos ver se aguenta um set de verdade. Me mostre o que voc√™ tem at√© chegarmos a 1000 de FAMA!", () => {
              showStatus("DJ BATTLE INICIADA!", true);
            });
          } else {
            showDialogue("Sofia", "Ainda temos o que conversar sobre aquele contrato...");
          }
        } else if (this.role === 'SECURITY') {
          if (chapter === 2) {
            showDialogue("Rafael (Seguran√ßa)", "Ei, DJ! Escuta... Algu√©m andou mexendo no sistema de c√¢meras do escrit√≥rio do Alex. Voc√™ devia dar uma olhada l√° atr√°s do bar.", () => {
              const trigger = document.getElementById('office-trigger');
              if (trigger) trigger.style.display = 'block';
            });
          } else {
            showDialogue("Rafael", "Tudo sob controle por aqui. Continue o show!");
          }
        } else if (this.role === 'INVESTIGATION') {
          showDialogue("Sistema", "Voc√™ encontrou documentos sobre uma d√≠vida secreta da boate... Algu√©m est√° tentando sabotar o Alex!", () => {
            this.element.style.display = 'none';
            completarMissao();
          });
        } else if (this.role === 'DJ') {
          interagirDJ();
        } else {
          showTip(this.element);
          addFama(this.role === 'GUEST' ? 5 : (this.role === 'VIP' ? 15 : 10));
          addMoney(this.role === 'GUEST' ? 2 : 10);
          showStatus(this.role === 'GUEST' ? "OBA!!" : `SALVE ${this.name}!`);
          this.interacted = true;
          checkMissions();
        }
      }

      scheduleNextAction() {
        const delay = 3000 + Math.random() * 5000;
        setTimeout(() => {
          this.decideNextState();
          this.scheduleNextAction();
        }, delay);
      }

      decideNextState() {
        if (this.role !== 'GUEST') return;
        const rand = Math.random();
        if (rand < 0.45) {
          const spot = HOTSPOTS[Math.floor(Math.random() * HOTSPOTS.length)];
          const targetX = spot.x + (Math.random() * 8 - 4);
          const targetY = spot.y + (Math.random() * 8 - 4);
          const dx = targetX - this.x;
          this.element.classList.remove('dancing');
          this.element.classList.add('walking');
          this.element.style.transform = dx > 0 ? 'scaleX(1)' : 'scaleX(-1)';
          this.x = targetX;
          this.y = targetY;
          this.updatePos();
          setTimeout(() => {
            this.element.classList.remove('walking');
            this.element.classList.add('dancing');
          }, 3000);
        } else if (rand < 0.85) {
          this.element.classList.remove('walking');
          this.element.classList.add('dancing');
        } else {
          this.element.classList.remove('walking', 'dancing');
        }
      }

      move() { }
    }

    let tutorialComplete = false;
    const chapters = [
      "Tutorial: Conhe√ßa Alex",
      "Cap 1: Conquistando a Boate",
      "Cap 2: Segredos da Noite",
      "Cap 3: Festa e Conquista",
      "Cap 4: O Grande Confronto"
    ];

    function spawnCharacters() {
      characters.forEach(c => c.element.remove());
      characters = [];

      // 1. Alex (Gerente)
      characters.push(new GameCharacter(4, { x: 15, y: 70 }, 'ALEX'));

      // 2. DJ
      characters.push(new GameCharacter(0, { x: 50, y: 30 }, 'DJ'));

      // 3. Rafael (Seguran√ßa)
      characters.push(new GameCharacter(1, { x: 80, y: 80 }, 'SECURITY', 'RAFAEL'));

      // 4. Barman
      characters.push(new GameCharacter(5, { x: 25, y: 50 }, 'BARMAN'));

      // 5. Lia (Dancer) - Chapter 1+
      if (chapter >= 1) {
        characters.push(new GameCharacter(7, { x: 50, y: 60 }, 'LIA'));
      }

      // 6. VIPs - Chapter 1+
      if (chapter >= 1) {
        for (let i = 0; i < 5; i++) {
          characters.push(new GameCharacter(10, { x: 75 + i * 2, y: 40 + i * 2 }, 'VIP'));
        }
      }

      // 6b. BOSS - Featured Character
      characters.push(new GameCharacter(0, { x: 82, y: 45 }, 'BOSS', 'VINCENT'));

      // 6c. Sofia (Rival DJ) - Chapter 3+
      if (chapter >= 3) {
        characters.push(new GameCharacter(12, { x: 55, y: 35 }, 'SOFIA'));
      }

      // 6d. Office Investigation Spot (Invisible initially)
      if (chapter === 2) {
        const doc = new GameCharacter(15, { x: 5, y: 25 }, 'INVESTIGATION', 'DOCUMENTOS');
        doc.element.id = 'office-trigger';
        doc.element.style.display = 'none';
        doc.element.style.filter = 'brightness(2) drop-shadow(0 0 10px gold)';
        characters.push(doc);
      }

      // 7. Guests
      for (let i = 0; i < 25; i++) {
        const spot = HOTSPOTS[i % HOTSPOTS.length];
        characters.push(new GameCharacter(i % 16, {
          x: spot.x + (Math.random() * 20 - 10),
          y: spot.y + (Math.random() * 20 - 10)
        }, 'GUEST'));
      }
    }

    function gameLoop() {
      characters.forEach(c => c.move());
      requestAnimationFrame(gameLoop);
    }

    function interagirDJ() {
      musicasTrocadas++;
      addFama(10);
      showStatus("NOVA TRACK!");
      tocarMusica();
      checkMissions();
    }

    function addFama(val) {
      fama += val;
      atualizarInterface();
      salvarProgresso();
    }

    function completarMissao() {
      chapter++;
      addFama(50);
      showStatus("CAP√çTULO CONCLU√çDO!", true);
      spawnCharacters();
      atualizarInterface();

      if (chapter >= chapters.length) {
        setTimeout(finalizarJogo, 3000);
      }
    }

    function checkMissions() {
      const interactedCount = characters.filter(c => c.interacted).length;
      if (chapter === 0 && tutorialComplete && musicasTrocadas > 0 && interactedCount >= 3) {
        completarMissao();
      } else if (chapter === 1) {
        const vips = characters.filter(c => c.role === 'VIP' && c.interacted).length;
        if (vips >= 3 && fama >= 200) {
          completarMissao();
        }
      } else if (chapter === 3) {
        if (fama >= 1000) {
          completarMissao();
        }
      }
    }

    function confirmarEscolhaFinal() {
      const box = document.getElementById('dialogue-box');
      box.innerHTML = `
        <div id="dialogue-name">SISTEMA</div>
        <div id="dialogue-text">Vincent fez uma oferta. O que voc√™ far√°?</div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" style="font-size: 14px; padding: 10px;" onclick="finalizarComEscolha('lealdade')">ACEITAR OFERTA (Ficar Rico)</button>
          <button class="btn" style="font-size: 14px; padding: 10px; background: red;" onclick="finalizarComEscolha('justica')">DENUNCIAR (Ficar Pobre mas Her√≥i)</button>
          <button class="btn" style="font-size: 14px; padding: 10px; background: gold; color: black;" onclick="finalizarComEscolha('ambicao')">TRAIR TUDO (Sider com Sofia)</button>
        </div>
      `;
      box.style.display = 'block';
      box.onclick = null; // Disable close on click
    }

    function finalizarComEscolha(tipo) {
      let msg = "";
      if (tipo === 'lealdade') msg = "Voc√™ escolheu o dinheiro. O Alex foi demitido, mas voc√™ agora √© o bra√ßo direito do Vincent.";
      if (tipo === 'justica') msg = "A verdade prevaleceu! Vincent foi preso e o Alex recuperou a boate. Voc√™ √© uma lenda urbana.";
      if (tipo === 'ambicao') msg = "O jogo virou! Voc√™ e Sofia expulsaram Vincent e Alex, tomando o controle da Noite Selvagem.";

      document.getElementById('club').style.display = 'none';
      document.getElementById('dialogue-box').style.display = 'none';
      document.getElementById('fim').style.display = 'flex';
      document.getElementById('fim').querySelector('h1').innerText = "FIM DA HIST√ìRIA";
      document.getElementById('fim').querySelector('p').innerText = msg;
      document.getElementById('famaFinal').innerText = fama;
    }

    function addMoney(val) {
      dinheiro += val;
      atualizarInterface();
      salvarProgresso();
    }

    async function toggleShop() {
      const overlay = document.getElementById('shop-overlay');
      if (overlay.style.display === 'block') {
        overlay.style.display = 'none';
      } else {
        overlay.style.display = 'block';
        loadShopItems('all');
      }
    }

    async function loadShopItems(category) {
      shopCategory = category;
      const tabs = document.querySelectorAll('.shop-tab');
      tabs.forEach(t => {
        t.classList.remove('active');
        if (t.innerText.toLowerCase().includes(category) || (category === 'all' && t.innerText === 'TUDO')) {
          t.classList.add('active');
        }
      });

      let itens = [];
      try {
        const res = await fetch(`${API_URL}/loja/itens`);
        if (res.ok) {
          itens = await res.json();
        } else { throw new Error(); }
      } catch (e) {
        console.warn("Using offline shop data");
        itens = [
          { "id": "vip_pass", "name": "VIP Pass üé´", "price": 100, "description": "Offline mode: permanent VIP access.", "type": "upgrade" },
          { "id": "energy_drink", "name": "Nitro Energy ‚ö°", "price": 25, "description": "Instant energy boost.", "type": "consumable" },
          { "id": "gift_rose", "name": "Rosa de Neon üåπ", "price": 50, "description": "Standard gift.", "type": "gift" },
          { "id": "gift_champagne", "name": "Champagne üçæ", "price": 200, "description": "Premium gift.", "type": "gift" }
        ];
      }

      if (category !== 'all') {
        itens = itens.filter(i => i.type === category);
      }

      const lista = document.getElementById('loja-lista');
      lista.innerHTML = '';

      if (category === 'gift') {
        lista.innerHTML = '<div style="grid-column: 1/-1; color: #ff00ff; font-weight: 900; margin-bottom: 10px;">üéÅ LOJA DE PRESENTES</div>';
      }

      itens.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        if (item.type === 'gift') div.style.borderColor = '#ff00ff';
        div.innerHTML = `
          <div style="font-size: 24px;">${item.name}</div>
          <div style="font-size: 12px; color: #888; margin: 10px 0;">${item.description}</div>
          <div class="money-stat">$${item.price}</div>
          <button class="btn" style="padding: 10px 20px; font-size: 14px; margin-top: 10px; ${item.type === 'gift' ? 'border-color: #ff00ff; color: #ff00ff;' : ''}" 
            ${dinheiro < item.price ? 'disabled style="opacity:0.5"' : ''}
            onclick="buyItem('${item.id}', ${item.price}, '${item.type}', '${item.name}')">COMPRAR</button>
        `;
        lista.appendChild(div);
      });
    }

    function buyItem(id, price, type, name) {
      if (dinheiro >= price) {
        dinheiro -= price;
        showStatus("COMPRADO!", true);

        if (type === 'gift') {
          inventario.push({ id, name });
        } else {
          if (id === 'vip_pass') addFama(100);
          if (id === 'energy_drink') addFama(50);
          if (id === 'golden_mic') addFama(200);
        }

        atualizarInterface();
        salvarProgresso();
        loadShopItems(shopCategory);
      }
    }

    function atualizarInterface() {
      document.getElementById('fama').innerText = fama;
      document.getElementById('dinheiro').innerText = `$${dinheiro}`;
      document.getElementById('missao').innerText = chapters[chapter];
    }

    function showGiftMenu(npcRole, npcName) {
      if (inventario.length === 0) {
        showDialogue("SISTEMA", "Voc√™ n√£o tem nenhum presente no invent√°rio. Visite a LOJA!");
        return;
      }

      const listHtml = inventario.map((item, idx) => `
        <div class="shop-item" style="cursor:pointer; margin-bottom:5px;" onclick="darPresente(${idx}, '${npcRole}', '${npcName}')">
          ${item.name}
        </div>
      `).join('');

      const box = document.getElementById('dialogue-box');
      box.innerHTML = `
        <div id="dialogue-name">SELECIONE UM PRESENTE</div>
        <div id="dialogue-text">${listHtml}</div>
        <button class="btn" style="margin-top:10px;" onclick="document.getElementById('dialogue-box').style.display='none'">CANCELAR</button>
      `;
      box.style.display = 'block';
    }

    function darPresente(itemIdx, npcRole, npcName) {
      const item = inventario[itemIdx];
      inventario.splice(itemIdx, 1);

      let reaction = "Ah, que gentil! Muito obrigada.";
      let bonusFama = 50;

      if (npcRole === 'LIA') {
        reaction = "Uau! Isso √© lindo! Voc√™ realmente sabe como tratar uma dama. Vou dan√ßar mais animada hoje!";
        bonusFama = 100;
      }
      if (npcRole === 'ALEX') {
        reaction = "Valeu, parceiro! Isso vai ajudar a manter o √¢nimo aqui na boate. Toma uma gorjeta!";
        addMoney(20);
      }
      if (npcRole === 'BOSS') {
        reaction = "Hm... Aceit√°vel. Voc√™ tem bom gosto para algu√©m do seu n√≠vel.";
        bonusFama = 150;
      }
      if (npcRole === 'SOFIA') {
        reaction = "Um presente? Est√° tentando me subornar? Bom... eu gostei, mas n√£o ache que vai ser f√°cil me vencer.";
        bonusFama = 100;
      }

      addFama(bonusFama);
      showDialogue(npcName, reaction);
      showStatus(`PRESENT√ÉO! +${bonusFama} FAMA`, true);
    }

    function showStatus(text, long = false) {
      const msg = document.getElementById('status-msg');
      msg.innerText = text;
      msg.style.opacity = 1;
      msg.style.transform = 'translateX(-50%) scale(1.2)';
      setTimeout(() => {
        msg.style.opacity = 0;
        msg.style.transform = 'translateX(-50%) scale(1)';
      }, long ? 2500 : 1000);
    }

    function showTip(elem) {
      const rect = elem.getBoundingClientRect();
      const tip = document.createElement('div');
      tip.className = 'mega-tip';
      tip.innerText = "YAY!!";
      tip.style.position = 'absolute';
      tip.style.color = '#ffd700';
      tip.style.fontWeight = '900';
      tip.style.fontSize = '24px';
      tip.style.left = `${rect.left + rect.width / 2}px`;
      tip.style.top = `${rect.top}px`;
      tip.style.pointerEvents = 'none';
      tip.style.zIndex = '300';
      document.body.appendChild(tip);
      setTimeout(() => tip.remove(), 1200);
    }

    function tocarMusica() {
      if (!playlist.length) return;
      const track = playlist[musicasTrocadas % playlist.length];
      audio.play(track.url);

      // Update Music Panel
      const info = document.getElementById('music-info');
      info.innerText = `${track.title} - ${track.artist || 'Unknown'}`;

      if (track.title) showStatus(`TRACK: ${track.title}`, true);
    }

    function finalizarJogo() {
      document.getElementById('club').style.display = 'none';
      document.getElementById('fim').style.display = 'flex';
      document.getElementById('famaFinal').innerText = fama;
    }
  </script>

</body>

</html>